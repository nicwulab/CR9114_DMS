---
title: "tite_seq_plot.Rmd"
output: html_document
date: "2023-01-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!file.exists("result")){
  dir.create(file.path("result"))
}
if(!file.exists("HC KD regression")){
  dir.create(file.path("HC KD regression"))
}
if(!file.exists("HC KD regression/rep1")){
  dir.create(file.path("HC KD regression/rep1"))
}
if(!file.exists("HC KD regression/rep2")){
  dir.create(file.path("HC KD regression/rep2"))
}
if(!file.exists("HC KD regression/mean")){
  dir.create(file.path("HC KD regression/mean"))
}
if(!file.exists("correlation")){
  dir.create(file.path("correlation"))
}
```

## R Markdown
this is R Markdown used for tite-seq NGS data visualization

```{r loard library}
#load packages
library(dplyr)
library(ggplot2)
library(data.table)
library(broom)
library(gridExtra)
library(tidyr)
library(readxl)

library(ggpubr)
require(cowplot)
```

## define function

```{r define function}
plot_kd_reg <- function(dt1,nls_broom, folder_suffix){
  concentration = c(1:20 %o% 10^(-13:-7)) # this should only generate 120 estimates per titration (faster!)
  nls_predictions <- dt1 %>%
    dplyr::select(mut) %>%
    merge(nls_broom %>%
            dplyr::select(-statistic, -p.value, -std.error) %>%
            spread(term, estimate),
          by="mut") %>%
    unique() %>%
    merge(dt1 %>% dplyr::select(mut, Kd_SE) %>% unique(), by="mut") %>%
    merge(as.data.frame(concentration), all=TRUE) %>%
    mutate(mean_bin = a*(concentration/(concentration+Kd))+b)
  
  annotations <- dt1 %>%
    dplyr::select(mut, Kd, Kd_SE,p.value) %>%
    unique()
  p<- ggplot(dt1, aes(conc, bin_mean)) +
    geom_point() +
    geom_line(data = nls_predictions,
              aes(concentration, mean_bin),
              color="red") + 
    scale_x_log10(lim=c(2e-14,2e-07)) +
    xlab("HA (M)") +
    ylab("Mean bin") +ggtitle(nls_predictions$mut[1])+
    geom_text(
      data    = annotations,
      mapping = aes(x = 5e-12,
                    y = 3,
                    label = c(paste(
                      "Kd=", format(Kd, digits=2),
                      "+/-", format(Kd_SE, digits=1), "M"," (p=",format(p.value, digits=2),")"))),
      size=2) +theme_cowplot(12)+
    theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
          plot.title = element_text(color="black", size=8, face="bold.italic"),
          axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
          axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
          axis.title=element_text(size=7,face="bold"),
          axis.line = element_line(colour = 'black', size = 0),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('HC KD regression/', folder_suffix, '/',
               nls_predictions$mut[1],'_regression_plot.png',sep=''),
         p,width=3, height=2, dpi=300,bg='white')
}
# define fun to plot correlation
plot_cor <- function(dt,bin){
  p1 <- ggscatter(dt, x = paste(bin,'1',sep=''), y = paste(bin,'2',sep=''), 
                conf.int = TRUE, size = 1,
                cor.coef = TRUE, cor.method = "spearman",
                xlab = "Replicate 1", ylab = "Replicate 2")+ 
  theme_cowplot(12)+
  theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
        plot.title = element_text(color="black", size=8, face="bold.italic"),
        axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
        axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
        axis.title=element_text(size=7,face="bold"),
        axis.line = element_line(colour = 'black', size = 0),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('correlation/correlation_',bin,'.png',sep=''),p1,width=3, height=3, dpi=300,bg='white')
}
# define fun to plot correlation
plot_cor_log1 <- function(dt,bin){
  p1 <- ggscatter(dt, x = paste(bin,'1',sep=''), y = paste(bin,'2',sep=''), 
                conf.int = TRUE, size = 1,
                cor.coef = TRUE, cor.method = "spearman",
                xlab = "Replicate 1", ylab = "Replicate 2")+ 
  yscale("log2", .format = TRUE)+ 
  xscale("log2", .format = TRUE)+
  theme_cowplot(12)+
  theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
        plot.title = element_text(color="black", size=8, face="bold.italic"),
        axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
        axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
        axis.title=element_text(size=7,face="bold"),
        axis.line = element_line(colour = 'black', size = 0),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('correlation/correlation_',bin,'.png',sep=''),p1,width=3, height=3, dpi=300,bg='white')
}
# define fun to plot correlation
plot_cor_log2 <- function(dt,bin,concentration){
  p1 <- ggscatter(dt, x = paste(bin,'1',sep=''), y = paste(bin,'2',sep=''), 
                conf.int = TRUE, size = 1,
                cor.coef = TRUE, cor.method = "spearman",
                xlab = "Replicate 1", ylab = "Replicate 2")+ 
  yscale("log2", .format = TRUE)+ 
  xscale("log2", .format = TRUE)+
  theme_cowplot(12)+
  theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
        plot.title = element_text(color="black", size=8, face="bold.italic"),
        axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
        axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
        axis.title=element_text(size=7,face="bold"),
        axis.line = element_line(colour = 'black', size = 0),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('correlation/correlation_',bin,concentration, '.png',sep=''),p1,width=3, height=3, dpi=300,bg='white')
}
```

Now let's read data and make some plots
```{r}
# read data as dataframe
dt <- read.csv(file="../CR9114HC_GL_count_aa.tsv", sep = '\t')

dt[is.na(dt)] <-0
info_df <- read_excel("../../doc/germline_CR9114_FACS_info.xlsx")

# add info into count table - dt
names(dt)[3:83] <- info_df$`FACS Label`
```

Data normalization

```{r}
# make total count for each sample
bin_count <- dt[, -c(1,2)] %>% colSums()
ratio <- c()
# calculate count/cell ratio
for (i in 1:81) {
  ratio[i]<- bin_count[i] / info_df$`FACS Counts`[i]
}
# normalization by count/cell ratio
for (i in 1:81) {
  dt[,i+2] <- dt[,i+2] / ratio[i]
}
# save date
write.csv(dt,'result/HC_count_table_norm.csv')

```

data clean

```{r}
# add filter for count table to make sure that bin1 has count if there no antigen
dt <- dt %>%
  filter(`20230301_negative_Gateun` >= 1)%>%
  filter(`20230302_negative_Gateun` >= 1)

# calculate bin mean

# concentration list
conc_ls <- c('16nM','5nM','1.6nM','0.5nM','0.05nM','0.16nM','0.005nM','0.016nM','negative','Hatag')
# bin list
bin_ls <- c('_Gateun','_Gate1','_Gate2','_Gate3')
# repeat date list
rep_ls <- c('20230301_','20230302_')

# Create an empty data frame with the desired columns
clean_df <- data.frame(mut = character(), 
                        conc = numeric(), 
                        mut_class = character(),
                        bin_mean1 = numeric(),
                        bin_mean2 = numeric(),
                        bin_mean = numeric())
# loop over rows
for (i in 1:nrow(dt)) {
  for (c in conc_ls){
    bin1_1=dt[i,paste0(rep_ls[1], c, bin_ls[1])]
    bin2_1=dt[i,paste0(rep_ls[1], c, bin_ls[2])]
    bin3_1=dt[i,paste0(rep_ls[1], c, bin_ls[3])]
    bin4_1=dt[i,paste0(rep_ls[1], c, bin_ls[4])]
    
    # calculate mean bin for repeat1
    bin_mean1 = (bin1_1*1+bin2_1*2+bin3_1*3+bin4_1*4)/(bin1_1+bin2_1+bin3_1+bin4_1)
    
    bin1_2=dt[i,paste0(rep_ls[2], c, bin_ls[1])]
    bin2_2=dt[i,paste0(rep_ls[2], c, bin_ls[2])]
    bin3_2=dt[i,paste0(rep_ls[2], c, bin_ls[3])]
    bin4_2=dt[i,paste0(rep_ls[2], c, bin_ls[4])]
      
    # calculate mean bin for repeat2
    bin_mean2 = (bin1_2*1+bin2_2*2+bin3_2*3+bin4_2*4)/(bin1_2+bin2_2+bin3_2+bin4_2)
    bin_mean = mean(c(bin_mean1,bin_mean2))
    # Create a new row of data and append it to the data frame
    new_row <- data.frame(mut = dt[i,"mut"], 
                          conc = c, 
                          mut_class = dt[i,"mut_class"], 
                          bin_mean1 = bin_mean1, 
                          bin_mean2 = bin_mean2, 
                          bin_mean = bin_mean)
    
    clean_df <- rbind(clean_df, new_row)
    }
}
write.table(clean_df, "result/clean_count_table.tsv", sep="\t", row.names=FALSE)
```

make correlation plot for replicates

```{r}
# make a plot for correlation for bin mean
plot_cor_log1(clean_df,'bin_mean')


# concentration list
conc_ls <- c('16nM','5nM','1.6nM','0.5nM','0.05nM','0.16nM','0.005nM','0.016nM','negative','Hatag')
for (c in conc_ls) {
  dt1 <- clean_df %>% filter(conc ==c)
  plot_cor_log2(dt1,'bin_mean',c)
}
# make conc numeric
clean_df$conc[clean_df$conc == '16nM'] <-16e-09
clean_df$conc[clean_df$conc == '5nM'] <-5e-09
clean_df$conc[clean_df$conc == '1.6nM'] <-16e-10
clean_df$conc[clean_df$conc == '0.5nM'] <-5e-10
clean_df$conc[clean_df$conc == '0.05nM'] <-5e-11
clean_df$conc[clean_df$conc == '0.16nM'] <-16e-11
clean_df$conc[clean_df$conc == '0.005nM'] <-5e-12
clean_df$conc[clean_df$conc == '0.016nM'] <-16e-12
clean_df$conc[clean_df$conc == 'negative'] <-0e+0

clean_df$conc = as.numeric(as.character(clean_df$conc))

```

loop over sample ID to do KD regression

```{r}
# make sure bin_0 is greater than bin_1 for no antigen
chosen_id <-unique(clean_df$mut)

KD_ls <- list()
# loop over sample id
for (id in chosen_id) {
  tryCatch({
    single_df <-  clean_df %>% filter(mut == id)
    nls_broom <- single_df %>%
      group_by(mut) %>%
      do(tidy(nls(bin_mean1 ~ a*(conc/(conc+Kd))+b,
                  data=.,
                  start=list(a=2,b=1,Kd=1e-9),
                  lower=list(a=1.5,b=1,Kd=5e-14),
                  upper=list(a=3,b=1.5,Kd=1e-5),
                  algorithm="port")))
    single_df <- single_df %>%
      merge(nls_broom %>%
              filter(term=="Kd") %>%
              rename(Kd="estimate",Kd_SE="std.error"), by="mut")
    single_df <- single_df[complete.cases(single_df),] # remove HA-tag row with null value
    
    plot_kd_reg(single_df,nls_broom, "rep1")
    
    KD_ls[[id]] <- single_df

    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
# merge kd dataframe by kd list
kd_df <-do.call("rbind",KD_ls)

# get kd summary
kd_summary <- kd_df %>%
  dplyr::select(mut, Kd, Kd_SE,p.value) %>%
  unique()
# save kd table
write.csv(kd_summary,"./result/HC_KD_table_rep1.csv", row.names = FALSE)

```
repeat2
```{r}
# make sure bin_0 is greater than bin_1 for no antigen
chosen_id <-unique(clean_df$mut)

KD_ls <- list()
# loop over sample id
for (id in chosen_id) {
  tryCatch({
    single_df <-  clean_df %>% filter(mut == id)
    nls_broom <- single_df %>%
      group_by(mut) %>%
      do(tidy(nls(bin_mean2 ~ a*(conc/(conc+Kd))+b,
                  data=.,
                  start=list(a=2,b=1,Kd=1e-9),
                  lower=list(a=1.5,b=1,Kd=5e-14),
                  upper=list(a=3,b=1.5,Kd=1e-5),
                  algorithm="port")))
    single_df <- single_df %>%
      merge(nls_broom %>%
              filter(term=="Kd") %>%
              rename(Kd="estimate",Kd_SE="std.error"), by="mut")
    single_df <- single_df[complete.cases(single_df),] # remove HA-tag row with null value
    
    plot_kd_reg(single_df,nls_broom, "rep2")
    
    KD_ls[[id]] <- single_df

    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
# merge kd dataframe by kd list
kd_df <-do.call("rbind",KD_ls)

# get kd summary
kd_summary <- kd_df %>%
  dplyr::select(mut, Kd, Kd_SE,p.value) %>%
  unique()
# save kd table
write.csv(kd_summary,"./result/HC_KD_table_rep2.csv", row.names = FALSE)

```
repeat mean
```{r}
chosen_id <-unique(clean_df$mut)
# Third regression (bin_mean)
KD_ls <- list()
# loop over sample id
for (id in chosen_id) {
  tryCatch({
    single_df <-  clean_df %>% filter(mut == id)
    nls_broom <- single_df %>%
      group_by(mut) %>%
      do(tidy(nls(bin_mean ~ a*(conc/(conc+Kd))+b,    # 这里改为bin_mean
                  data=.,
                  start=list(a=2,b=1,Kd=1e-9),
                  lower=list(a=1.5,b=1,Kd=5e-14),
                  upper=list(a=3,b=1.5,Kd=1e-5),
                  algorithm="port")))
    single_df <- single_df %>%
      merge(nls_broom %>%
              filter(term=="Kd") %>%
              rename(Kd="estimate",Kd_SE="std.error"), by="mut")
    single_df <- single_df[complete.cases(single_df),] # remove HA-tag row with null value
    
    plot_kd_reg(single_df, nls_broom, "mean")    # 这里改为"mean"
    
    KD_ls[[id]] <- single_df

    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
# merge kd dataframe by kd list
kd_df <-do.call("rbind",KD_ls)

# get kd summary
kd_summary <- kd_df %>%
  dplyr::select(mut, Kd, Kd_SE,p.value) %>%
  unique()
# save kd table
write.csv(kd_summary,"./result/HC_KD_table_mean.csv", row.names = FALSE)
```

calulate correlation
```{r}
kd_rep1 <- read.csv(file="./result/HC_KD_table_rep1.csv", stringsAsFactors=F)
kd_rep2 <- read.csv(file="./result/HC_KD_table_rep2.csv", stringsAsFactors=F)
#kd_df <- read.csv(file="./result/HC_KD_table_summary.csv", stringsAsFactors=F)
merged_df <- merge(kd_rep1, kd_rep2, by = "mut", all = TRUE)
# Extract position from the 'mut' column
merged_df$position <- as.numeric(gsub("[^0-9]", "", merged_df$mut))

# Sort the data frame by the 'position' column
merged_df <- merged_df[order(merged_df$position), ]

write.csv(merged_df,"./result/HC_KD_table_summary_rep.csv", row.names = FALSE)
correlation <- cor(merged_df$Kd.x, merged_df$Kd.y,method = "spearman", use = "pairwise.complete.obs")

print(correlation)
```
