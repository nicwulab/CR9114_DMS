---
title: "tite_seq_plot.Rmd"
output: html_document
date: "2023-01-25"
---

```{r setup, include=FALSE}
if(!file.exists("result")){
  dir.create(file.path("result"))
}
if(!file.exists("HC KD regression")){
  dir.create(file.path("HC KD regression"))
}
if(!file.exists("HC KD regression/rep1")){
  dir.create(file.path("HC KD regression/rep1"))
}
if(!file.exists("HC KD regression/rep2")){
  dir.create(file.path("HC KD regression/rep2"))
}
if(!file.exists("HC KD regression/mean")){
  dir.create(file.path("HC KD regression/mean"))
}
if(!file.exists("correlation")){
  dir.create(file.path("correlation"))
}
```

## R Markdown
this is R Markdown used for tite-seq NGS data visualization

```{r loard library}
#load packages
library(dplyr)
library(ggplot2)
library(data.table)
library(broom)
library(gridExtra)
library(tidyr)
library(readxl)

library(ggpubr)
require(cowplot)
```

## define function

```{r define function}
plot_kd_reg <- function(dt1,nls_broom, folder_suffix){
  concentration = c(1:20 %o% 10^(-13:-7)) # this should only generate 120 estimates per titration (faster!)
  nls_predictions <- dt1 %>%
    dplyr::select(mut) %>%
    merge(nls_broom %>%
            dplyr::select(-statistic, -p.value, -std.error) %>%
            spread(term, estimate),
          by="mut") %>%
    unique() %>%
    merge(dt1 %>% dplyr::select(mut, Kd_SE) %>% unique(), by="mut") %>%
    merge(as.data.frame(concentration), all=TRUE) %>%
    mutate(mean_bin = a*(concentration/(concentration+Kd))+b)
  
  annotations <- dt1 %>%
    dplyr::select(mut, Kd, Kd_SE,p.value) %>%
    unique()
  p<- ggplot(dt1, aes(conc, bin_mean)) +
    geom_point() +
    geom_line(data = nls_predictions,
              aes(concentration, mean_bin),
              color="red") + 
    scale_x_log10(lim=c(2e-14,2e-07)) +
    xlab("HA (M)") +
    ylab("Mean bin") +ggtitle(nls_predictions$mut[1])+
    geom_text(
      data    = annotations,
      mapping = aes(x = 5e-12,
                    y = 3,
                    label = c(paste(
                      "Kd=", format(Kd, digits=2),
                      "+/-", format(Kd_SE, digits=1), "M"," (p=",format(p.value, digits=2),")"))),
      size=2) +theme_cowplot(12)+
    theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
          plot.title = element_text(color="black", size=8, face="bold.italic"),
          axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
          axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
          axis.title=element_text(size=7,face="bold"),
          axis.line = element_line(colour = 'black', size = 0),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('HC KD regression/', folder_suffix, '/',
               nls_predictions$mut[1],'_regression_plot.png',sep=''),
         p,width=3, height=2, dpi=300,bg='white')
}
# define fun to plot correlation
plot_cor <- function(dt,bin){
  p1 <- ggscatter(dt, x = paste(bin,'1',sep=''), y = paste(bin,'2',sep=''), 
                conf.int = TRUE, size = 1,
                cor.coef = TRUE, cor.method = "spearman",
                xlab = "Replicate 1", ylab = "Replicate 2")+ 
  theme_cowplot(12)+
  theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
        plot.title = element_text(color="black", size=8, face="bold.italic"),
        axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
        axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
        axis.title=element_text(size=7,face="bold"),
        axis.line = element_line(colour = 'black', size = 0),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('correlation/correlation_',bin,'.png',sep=''),p1,width=3, height=3, dpi=300,bg='white')
}
# define fun to plot correlation
plot_cor_log1 <- function(dt,bin){
  p1 <- ggscatter(dt, x = paste(bin,'1',sep=''), y = paste(bin,'2',sep=''), 
                conf.int = TRUE, size = 1,
                cor.coef = TRUE, cor.method = "spearman",
                xlab = "Replicate 1", ylab = "Replicate 2")+ 
  yscale("log2", .format = TRUE)+ 
  xscale("log2", .format = TRUE)+
  theme_cowplot(12)+
  theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
        plot.title = element_text(color="black", size=8, face="bold.italic"),
        axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
        axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
        axis.title=element_text(size=7,face="bold"),
        axis.line = element_line(colour = 'black', size = 0),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('correlation/correlation_',bin,'.png',sep=''),p1,width=3, height=3, dpi=300,bg='white')
}
# define fun to plot correlation
plot_cor_log2 <- function(dt,bin,concentration){
  p1 <- ggscatter(dt, x = paste(bin,'1',sep=''), y = paste(bin,'2',sep=''), 
                conf.int = TRUE, size = 1,
                cor.coef = TRUE, cor.method = "spearman",
                xlab = "Replicate 1", ylab = "Replicate 2")+ 
  yscale("log2", .format = TRUE)+ 
  xscale("log2", .format = TRUE)+
  theme_cowplot(12)+
  theme(axis.text=element_text(size=7,face="bold",colour = 'black'),
        plot.title = element_text(color="black", size=8, face="bold.italic"),
        axis.text.x=element_text(angle=0,hjust=0.5,vjust=0.5,colour = 'black'),
        axis.text.y=element_text(hjust=0.5,vjust=0.5,colour = 'black'),
        axis.title=element_text(size=7,face="bold"),
        axis.line = element_line(colour = 'black', size = 0),
        panel.border = element_rect(colour = "black", fill=NA, size=1))
  ggsave(paste('correlation/correlation_',bin,concentration, '.png',sep=''),p1,width=3, height=3, dpi=300,bg='white')
}
```

Now let's read data and make some plots
```{r}
# read data as dataframe
dt <- read.csv(file="../CR9114HC_WT_count_aa_H3.tsv", sep = '\t')
dt[is.na(dt)] <- 0

# 删除带有'pre'的列
dt <- dt[, !grepl("pre", names(dt))]

# 处理info_df
info_df <- read_excel("../../doc/somatic_CR9114_FACS_info.xlsx", sheet = 'H3')
info_df <- info_df %>%
  filter(!grepl("pre", `Sequencing Label`))

# 简单的标准化函数
standardize_name <- function(name) {
  name <- gsub("^X", "", name)  # 删除开头的X
  name <- gsub("\\.", "-", name)  # 将点替换为横线
  return(name)
}

# 标准化dt的列名
names(dt) <- sapply(names(dt), standardize_name)

# 创建排序函数
get_sort_values <- function(name) {
  # 分割前缀和后缀
  prefix <- as.numeric(sub("-.*", "", name))  # 提取-前面的数字
  suffix <- sub(".*-", "", name)  # 提取-后面的部分
  
  # 如果后缀是字母，转换为数字
  if(grepl("^[A-Z]$", suffix)) {
    suffix_num <- 100 + which(LETTERS == suffix)
  } else {
    suffix_num <- as.numeric(suffix)
  }
  
  return(data.frame(prefix = prefix, suffix = suffix_num))
}

# 对dt的列名排序
dt_cols <- names(dt)[3:ncol(dt)]
dt_sort_values <- do.call(rbind, lapply(dt_cols, get_sort_values))
dt_sort_order <- order(dt_sort_values$prefix, dt_sort_values$suffix)
dt <- dt[, c(1:2, dt_sort_order + 2)]

# 对info_df排序
info_sort_values <- do.call(rbind, lapply(info_df$`Sequencing Label`, get_sort_values))
info_sort_order <- order(info_sort_values$prefix, info_sort_values$suffix)
info_df <- info_df[info_sort_order, ]

print("排序后的dt列名：")
print(names(dt)[3:ncol(dt)])
print("排序后info_df的标签：")
print(info_df$`Sequencing Label`)

# 创建FACS标签
create_facs_labels <- function(row) {
  # 获取FACS Label和Gate Numerical
  facs_label <- row["FACS Label"]
  gate_num <- as.numeric(row["Gate, Numerical"])
  
  # 移除HAtag（如果存在）
  facs_label <- gsub(" HAtag", "", facs_label)
  
  # 分割字符串
  facs_parts <- strsplit(facs_label, "_")[[1]]
  date <- facs_parts[1]      # 获取日期部分
  conc <- facs_parts[3]      # 获取浓度部分
  
  # 使用ifelse处理gate标签（包含NA处理）
  gate_label <- ifelse(is.na(gate_num), "_Unknown",
                ifelse(gate_num == 1, "_Gateun",
                ifelse(gate_num == 2, "_Gate1",
                ifelse(gate_num == 3, "_Gate2",
                ifelse(gate_num == 4, "_Gate3", "_Unknown")))))
  
  # 构建新的标签
  new_label <- paste0(date, "_", conc, gate_label)
  
  return(new_label)
}

# 创建新的FACS标签
info_df$new_facs_label <- apply(info_df, 1, create_facs_labels)

# 验证列数匹配
if(ncol(dt) - 2 == nrow(info_df)) {
  names(dt)[3:ncol(dt)] <- info_df$new_facs_label
} else {
  stop("列数不匹配：dt有", ncol(dt) - 2, "列要重命名，但info_df有", nrow(info_df), "行")
}

# 打印检查结果
print("重命名后的dt列名：")
print(names(dt))
```

Data normalization

```{r}
# make total count for each sample
bin_count <- dt[, -c(1,2)] %>% colSums()
ratio <- c()
# calculate count/cell ratio
length = length(info_df$`FACS Counts`)
print(length)
info_df$`FACS Counts` <- as.numeric(info_df$`FACS Counts`)
for (i in 1:length) {
  ratio[i]<- bin_count[i] / info_df$`FACS Counts`[i]
}
# normalization by count/cell ratio
for (i in 1:length) {
  dt[,i+2] <- dt[,i+2] / ratio[i]
}
# save date
write.csv(dt,'result/HC_count_table_norm.csv')

```

data clean

```{r}
# add filter for count table to make sure that bin1 has count if there no antigen
dt <- dt %>%
  filter(`2024.07.15_0.033nM_Gateun` >= 1)%>%
  filter(`2024.07.16_0.033nM_Gateun` >= 1)

# calculate bin mean

# concentration list
conc_ls <- c('100nM','33.3nM','10nM','3.33nM','1nM','0.33nM','0.1nM','0.033nM')
# bin list
bin_ls <- c('_Gateun','_Gate1','_Gate2','_Gate3')
# repeat date list
rep_ls <- c('2024.07.15_','2024.07.16_')

# Create an empty data frame with the desired columns
clean_df <- data.frame(mut = character(), 
                        conc = numeric(), 
                        mut_class = character(),
                        bin_mean1 = numeric(),
                        bin_mean2 = numeric(),
                        bin_mean = numeric())
# loop over rows
for (i in 1:nrow(dt)) {
  for (c in conc_ls){
    bin1_1=dt[i,paste0(rep_ls[1], c, bin_ls[1])]
    bin2_1=dt[i,paste0(rep_ls[1], c, bin_ls[2])]
    bin3_1=dt[i,paste0(rep_ls[1], c, bin_ls[3])]
    bin4_1=dt[i,paste0(rep_ls[1], c, bin_ls[4])]
    
    # calculate mean bin for repeat1
    bin_mean1 = (bin1_1*1+bin2_1*2+bin3_1*3+bin4_1*4)/(bin1_1+bin2_1+bin3_1+bin4_1)
    
    bin1_2=dt[i,paste0(rep_ls[2], c, bin_ls[1])]
    bin2_2=dt[i,paste0(rep_ls[2], c, bin_ls[2])]
    bin3_2=dt[i,paste0(rep_ls[2], c, bin_ls[3])]
    bin4_2=dt[i,paste0(rep_ls[2], c, bin_ls[4])]
      
    # calculate mean bin for repeat2
    bin_mean2 = (bin1_2*1+bin2_2*2+bin3_2*3+bin4_2*4)/(bin1_2+bin2_2+bin3_2+bin4_2)
    bin_mean = mean(c(bin_mean1,bin_mean2))
    # Create a new row of data and append it to the data frame
    new_row <- data.frame(mut = dt[i,"mut"], 
                          conc = c, 
                          mut_class = dt[i,"mut_class"], 
                          bin_mean1 = bin_mean1, 
                          bin_mean2 = bin_mean2, 
                          bin_mean = bin_mean)
    
    clean_df <- rbind(clean_df, new_row)
    }
}
write.table(clean_df, "result/clean_count_table.tsv", sep="\t", row.names=FALSE)
```

make correlation plot for replicates

```{r}
# make a plot for correlation for bin mean
plot_cor_log1(clean_df,'bin_mean')


# concentration list
conc_ls <- c('100nM','33.3nM','10nM','3.33nM','1nM','0.33nM','0.1nM','0.033nM')
for (c in conc_ls) {
  dt1 <- clean_df %>% filter(conc ==c)
  plot_cor_log2(dt1,'bin_mean',c)
}
# make conc numeric
clean_df$conc[clean_df$conc == '100nM'] <-100e-09
clean_df$conc[clean_df$conc == '33.3nM'] <-33.3e-09
# clean_df$conc[clean_df$conc == '30nM'] <-30e-09
clean_df$conc[clean_df$conc == '10nM'] <-10e-09
clean_df$conc[clean_df$conc == '3.33nM'] <-3.33e-09
clean_df$conc[clean_df$conc == '1nM'] <-1e-09
clean_df$conc[clean_df$conc == '0.33nM'] <-0.33e-09
clean_df$conc[clean_df$conc == '0.1nM'] <-0.1e-09
clean_df$conc[clean_df$conc == '0.033nM'] <-0.033e-09


clean_df$conc = as.numeric(as.character(clean_df$conc))

```

loop over sample ID to do KD regression

```{r}
# make sure bin_0 is greater than bin_1 for no antigen
chosen_id <-unique(clean_df$mut)

KD_ls <- list()
# loop over sample id
for (id in chosen_id) {
  tryCatch({
    single_df <-  clean_df %>% filter(mut == id)
    nls_broom <- single_df %>%
      group_by(mut) %>%
      do(tidy(nls(bin_mean1 ~ a*(conc/(conc+Kd))+b,
                  data=.,
                  start=list(a=2,b=1,Kd=1e-9),
                  lower=list(a=1.5,b=1,Kd=5e-14),
                  upper=list(a=3,b=1.5,Kd=1e-5),
                  algorithm="port")))
    single_df <- single_df %>%
      merge(nls_broom %>%
              filter(term=="Kd") %>%
              rename(Kd="estimate",Kd_SE="std.error"), by="mut")
    single_df <- single_df[complete.cases(single_df),] # remove HA-tag row with null value
    
    plot_kd_reg(single_df,nls_broom, "rep1")
    
    KD_ls[[id]] <- single_df

    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
# merge kd dataframe by kd list
kd_df <-do.call("rbind",KD_ls)

# get kd summary
kd_summary <- kd_df %>%
  dplyr::select(mut, Kd, Kd_SE,p.value) %>%
  unique()
# save kd table
write.csv(kd_summary,"./result/HC_KD_table_rep1.csv", row.names = FALSE)

```
repeat2
```{r}
# make sure bin_0 is greater than bin_1 for no antigen
chosen_id <-unique(clean_df$mut)

KD_ls <- list()
# loop over sample id
for (id in chosen_id) {
  tryCatch({
    single_df <-  clean_df %>% filter(mut == id)
    nls_broom <- single_df %>%
      group_by(mut) %>%
      do(tidy(nls(bin_mean2 ~ a*(conc/(conc+Kd))+b,
                  data=.,
                  start=list(a=2,b=1,Kd=1e-9),
                  lower=list(a=1.5,b=1,Kd=5e-14),
                  upper=list(a=3,b=1.5,Kd=1e-5),
                  algorithm="port")))
    single_df <- single_df %>%
      merge(nls_broom %>%
              filter(term=="Kd") %>%
              rename(Kd="estimate",Kd_SE="std.error"), by="mut")
    single_df <- single_df[complete.cases(single_df),] # remove HA-tag row with null value
    
    plot_kd_reg(single_df,nls_broom, "rep2")
    
    KD_ls[[id]] <- single_df

    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
# merge kd dataframe by kd list
kd_df <-do.call("rbind",KD_ls)

# get kd summary
kd_summary <- kd_df %>%
  dplyr::select(mut, Kd, Kd_SE,p.value) %>%
  unique()
# save kd table
write.csv(kd_summary,"./result/HC_KD_table_rep2.csv", row.names = FALSE)
```
repeat mean

```{r}
# Third regression (bin_mean)
KD_ls <- list()
# loop over sample id
for (id in chosen_id) {
  tryCatch({
    single_df <-  clean_df %>% filter(mut == id)
    nls_broom <- single_df %>%
      group_by(mut) %>%
      do(tidy(nls(bin_mean ~ a*(conc/(conc+Kd))+b,    # 这里改为bin_mean
                  data=.,
                  start=list(a=2,b=1,Kd=1e-9),
                  lower=list(a=1.5,b=1,Kd=5e-14),
                  upper=list(a=3,b=1.5,Kd=1e-5),
                  algorithm="port")))
    single_df <- single_df %>%
      merge(nls_broom %>%
              filter(term=="Kd") %>%
              rename(Kd="estimate",Kd_SE="std.error"), by="mut")
    single_df <- single_df[complete.cases(single_df),] # remove HA-tag row with null value
    
    plot_kd_reg(single_df, nls_broom, "mean")    # 这里改为"mean"
    
    KD_ls[[id]] <- single_df

    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
# merge kd dataframe by kd list
kd_df <-do.call("rbind",KD_ls)

# get kd summary
kd_summary <- kd_df %>%
  dplyr::select(mut, Kd, Kd_SE,p.value) %>%
  unique()
# save kd table
write.csv(kd_summary,"./result/HC_KD_table_mean.csv", row.names = FALSE)
```
calulate correlation
```{r}
kd_rep1 <- read.csv(file="./result/HC_KD_table_rep1.csv", stringsAsFactors=F)
kd_rep2 <- read.csv(file="./result/HC_KD_table_rep2.csv", stringsAsFactors=F)
#kd_df <- read.csv(file="./result/HC_KD_table_summary.csv", stringsAsFactors=F)
merged_df <- merge(kd_rep1, kd_rep2, by = "mut", all = TRUE)
# Extract position from the 'mut' column
merged_df$position <- as.numeric(gsub("[^0-9]", "", merged_df$mut))

# Sort the data frame by the 'position' column
merged_df <- merged_df[order(merged_df$position), ]

write.csv(merged_df,"./result/HC_KD_table_summary_rep.csv", row.names = FALSE)
correlation <- cor(merged_df$Kd.x, merged_df$Kd.y,method = "spearman", use = "pairwise.complete.obs")

print(correlation)
```
